---
title: "GTEx Parsing"
author: "Matthew Berginski"
date: "April 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)

library(DarkKinaseTools)
```

# Download GTEx Data

```{r download}
GTEx_file = here('GTEx/GTEx_Analysis_2016-01-15_v7_RNASeQCv1.1.8_gene_median_tpm.gct.gz')

if (! file.exists(GTEx_file)) {
  download.file(url = "https://storage.googleapis.com/gtex_analysis_v7/rna_seq_data/GTEx_Analysis_2016-01-15_v7_RNASeQCv1.1.8_gene_median_tpm.gct.gz",
                GTEx_file)
}

GTEx_data = read_delim(GTEx_file,delim="\t",skip=2)
```

# Kinase Extraction

```{r kinase_filtering}
kinase_data_tidy = GTEx_data %>%
  right_join(all_kinases %>% select('class','symbol'), 
             by=c('Description'='symbol')) %>%
  select(-gene_id) %>%
  rename(symbol=Description) %>%
  gather("tissue_type","TPM",-symbol,-class) %>%
  filter(!is.na(TPM))

#Removing some tissue types that don't match up with body parts
kinase_data_tidy = kinase_data_tidy %>%
  filter(tissue_type != "Cells - EBV-transformed lymphocytes",
         tissue_type != "Cells - Transformed fibroblasts")

GTEx_to_gganato = read_rds(here('GTEx/GTEx_tissue_to_gganato.rds'))

kinase_data_tidy = kinase_data_tidy %>%
  left_join(GTEx_to_gganato)
```

```{r kinase_expression_levels}
kinase_mean_expression = kinase_data_tidy %>%
  group_by(symbol,class) %>%
  summarise(mean_expression = mean(TPM))

kinase_percentile_per_tissue = kinase_data_tidy %>%
  group_by(tissue_type) %>%
  mutate(kinase_percentile = 100*round(percent_rank(TPM),2)) %>%
  write_csv(here('GTEx/GTex_kinase_percentiles.csv'))

highly_expressed_DK = kinase_percentile_per_tissue %>%
  filter(class == "Dark",kinase_percentile >= 90)

write_csv(highly_expressed_DK,here('GTEx/highly_expressed_DK_90_percentile.csv'))

dir.create(here('GTEx','GTEx_highly_expressed_kinases'),showWarnings = F)
for (this_tissue in unique(highly_expressed_DK$tissue_type)) {
  this_kinase_data = highly_expressed_DK %>% 
    filter(tissue_type == this_tissue) %>% 
    arrange(desc(kinase_percentile))
  write_csv(this_kinase_data, here('GTEx','GTEx_highly_expressed_kinases',paste0(this_tissue,'.csv')))
}
```

```{r}
calc_cor <- function(kinase_1, kinase_2, percentile_data = kinase_percentile_per_tissue) {
  library(broom)
  kinase_1_percentiles = (kinase_percentile_per_tissue %>% filter(symbol == kinase_1))$kinase_percentile
  kinase_2_percentiles = (kinase_percentile_per_tissue %>% filter(symbol == kinase_2))$kinase_percentile
  return(tidy(cor.test(kinase_1_percentiles,kinase_2_percentiles))$estimate)
}

calc_mean_diff <- function(kinase_1, kinase_2, percentile_data = kinase_percentile_per_tissue) {
  kinase_1_percentiles = (kinase_percentile_per_tissue %>% filter(symbol == kinase_1))$kinase_percentile
  kinase_2_percentiles = (kinase_percentile_per_tissue %>% filter(symbol == kinase_2))$kinase_percentile
  return(mean(abs(kinase_1_percentiles - kinase_2_percentiles)))
}

library(tictoc)
library(furrr)
plan(multiprocess)
tic()
kinase_expression_correlations = crossing(kinase_1 = unique(kinase_percentile_per_tissue$symbol),
                                          kinase_2 = unique(kinase_percentile_per_tissue$symbol)) %>%
  filter(kinase_1 != kinase_2) %>%
  mutate(kinase_percentile_cor = future_map2_dbl(kinase_1, kinase_2, calc_cor)) %>%
  mutate(mean_diff = future_map2_dbl(kinase_1, kinase_2, calc_mean_diff)) %>%
  mutate(kinase_percentile_cor = round(kinase_percentile_cor,2)) %>%
  mutate(mean_diff = round(mean_diff,2)) %>%
  left_join(all_kinases %>% select(symbol,class), by=c("kinase_1"="symbol")) %>%
  rename(kinase_1_class = class) %>%
  left_join(all_kinases %>% select(symbol,class), by=c("kinase_2"="symbol")) %>%
  rename(kinase_2_class = class) %>%
  write_rds(here('GTEx/GTEx_expression_correlations.rds'))
  identity()
toc()
```
```{r}
GTEx_expression_correlations %>%
  filter(kinase_1_class == "Dark") %>%
  write_rds(here('GTEx/GTEx_expression_correlations_DK_only.rds'))
```

```{r}


temp = kinase_expression_correlations %>% 
  filter(kinase_1_class == "Dark", kinase_2_class == "Light") %>% 
  filter(kinase_1 == "MKNK2") %>%
  arrange(desc(cor_signf))

percentile_comparisons = kinase_percentile_per_tissue %>% 
  filter(symbol %in% c(temp$kinase_2[1:5])) %>% 
  left_join(kinase_percentile_per_tissue %>% 
              filter(symbol == "MKNK2") %>%
              select(tissue_type,kinase_percentile) %>%
              rename(DK_percentile = kinase_percentile))

library(BerginskiRMisc)
ggplot(percentile_comparisons, aes(x=DK_percentile,y=kinase_percentile, color=symbol)) + 
  geom_point() +
  xlim(0,100) + 
  ylim(0,100) + theme_berginski()
```

```{r}
highly_expressed_DK_tissue_counts = highly_expressed_DK %>%
  group_by(tissue_type) %>%
  summarise(DK_count = n())

highly_expressed_DK_gene_counts = highly_expressed_DK %>%
  group_by(symbol) %>%
  summarise(tissue_count = n())
```
